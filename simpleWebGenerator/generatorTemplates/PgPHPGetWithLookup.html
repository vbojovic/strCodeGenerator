<script type="text/html" id="user_tmpl">
<!-- 
    mroam imat kod updejta i ID i sva ostala polja . neautoinkrementirajuci i PKey polja
    ona koja se automatski psotavljaju mine trebaju
-->
    <pre>
       <code>
           
<ol  >       
    <li>class ProjectSql{</li>
    <li>    var $db=new DatabaseConnection();</li>
<%    
 for ( var i = 0; i < selectedTables.length; i++ ) {            
     var schemaName=selectedTables[i].schema;              
     var tableName=selectedTables[i].table;                
     var refTableSchemas = generator.getReferencingTables(schemaName,tableName); 

     var attribsInPkey=generator.getPkeyFieldNames(schemaName,tableName); 
     var attribsInPkeyJoined=(generator.getPkeyFieldNamesWithTablePrefix(schemaName,tableName)).join(','); 

     var phpArgsPkey = genericHelper.joinArrayWithPRefixes(attribsInPkey, '$', ','); 
     var phpVars = genericHelper.joinArrayWithPRefixes(attribsInPkey, '{$', '},')+'}"'; 
     var phpKeyVarsInStr = genericHelper.joinArrayWithGlues(attribsInPkey, '\'{$', '}\''  ,  ',');   

     var allAttribs =generator.getTableFieldNamesWithAliasesArr(schemaName, tableName, tableName, false); 

     var allAttribsJoined =allAttribs.join(','); 
     var attribsNonAutogenerated=generator.getTableFieldNamesArr(schemaName,tableName,true); 
     var attribsNonAutogeneratedJoined=attribsNonAutogenerated.join(','); 
     var phpArgs = genericHelper.joinArrayWithPRefixes(attribsNonAutogenerated, '$', ','); 
     var phpVars = genericHelper.joinArrayWithPRefixes(generator.getTableFieldNamesArr(schemaName,tableName,true), '{$', '},')+'}"'; 
     var funcName = generator.getFunctionName(schemaName,tableName,false); 
     var userFiltersJoined = "";
     var userFilters = new Array();

    var userFields = generator.getUserFieldNamesFromTable(schemaName, tableName);
    if (!(userFields == null || userFields.length==0) ){
        for (var k = 0 ; k<userFields.length ; k++){
            var userFieldName = refS+'.'+refT+i+'.'+userFields[k];
            userFilters.push(userFieldName);
        }     
    }
%>     
<li>public function <%=funcName%>GetJoined(<%=phpArgsPkey%>){     </li>
<li>    $sql="select    <%=allAttribsJoined%></li>
<%
        if (refTableSchemas != null){
            var additionalFields = new Array();
            for ( var j = 0; j < refTableSchemas.length; j++ ) {
                var refT = refTableSchemas[j].table;
                var refS = refTableSchemas[j].schema;
                var attribs = generator.getTableFieldNamesWithAliasesArr(refS,refT,refT+i,false);
                additionalFields.push(attribs);

                var userFields = generator.getUserFieldNamesFromTable(refS, refT);
                if (userFields == null || userFields.length==0) continue;
                for (var k = 0 ; k<userFields.length ; k++){
                    var userFieldName = refS+'.'+refT+i+'.'+userFields[k];
                    userFilters.push(userFieldName);
                }
            }
            additionalFields=genericHelper.unique(additionalFields);
            for ( var j = 0; j < additionalFields.length; j++ ) {
                %><li>,<%=additionalFields[j]%></li><%
            }

        }
%>
<li>        FROM <%=schemaName%>.<%=tableName%>  </li>
<%
        if (refTableSchemas != null){
            var joinedTables = '';
            for ( var j = 0; j < refTableSchemas.length; j++ ) {
                var refT = refTableSchemas[j].table;
                var refS = refTableSchemas[j].schema;
                /* = glueArrayElements(arr, prefix, sufix)*/
                var refFields = generator.getPkeyFieldNames(refS,refT);
                /*var refFieldSchTableNames = genericHelper.glueArrayElements(refFields, refS+'.'+refT+'.', '').join(',');*/
                var refFieldSchTableNames = genericHelper.glueArrayElements(refFields,  refT+j+'.', '').join(',');

                var fkeyNames = generator.getFkeyNamesBetweenTables(schemaName,tableName,refS,refT);
                if (fkeyNames==null || fkeyNames.length == 0) continue;
                for (var k = 0; k < fkeyNames.length; k++){
                    var fieldNames = generator.getFKeyFieldNames(schemaName,tableName,fkeyNames[k],false);
                    if (fieldNames == null){
                        console.log(fkeyNames[k]);
                        console.log(refT+' <- '+tableName);
                        continue;
                    }
                    var fieldNamesJoined = genericHelper.glueArrayElements(fieldNames,  schemaName+'.'+tableName+'.', '').join(',');
%><li>      LEFT JOIN  <%=refS%>.<%=refT%> <%=refT%><%=j%>  ON (<%=refFieldSchTableNames%>) = (<%=fieldNamesJoined%>)  </li><%

                }


            }
        }
%>
<li>        WHERE   (<%=attribsInPkeyJoined%> )=(<%=phpKeyVarsInStr%>)"  <%=userFiltersJoined%> ; </li>
<li>   $this->db->setQuery($sql);              </li>
<li>   return $this->db->sql2row($sql);        </li>
<li>}               </li>

<% }%> 
<li>}</li>
</ol>
           
   </code>
    </pre>
 </script>
